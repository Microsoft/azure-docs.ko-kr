---
title: MABS를 사용 하 여 Hyper-v 가상 머신 백업
description: 이 문서에는 MABS (Microsoft Azure Backup 서버)를 사용 하 여 가상 컴퓨터를 백업 및 복구 하는 절차가 포함 되어 있습니다.
ms.topic: conceptual
ms.date: 07/18/2019
ms.openlocfilehash: 3bca1b46a867c2967dfcebe4bc8477d5f9c9447d
ms.sourcegitcommit: 4821b7b644d251593e211b150fcafa430c1accf0
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 11/19/2019
ms.locfileid: "74173527"
---
# <a name="back-up-hyper-v-virtual-machines-with-azure-backup-server"></a>Azure Backup Server를 사용 하 여 Hyper-v 가상 컴퓨터 백업

이 문서에서는 MABS (Microsoft Azure Backup 서버)를 사용 하 여 Hyper-v 가상 컴퓨터를 백업 하는 방법을 설명 합니다.

## <a name="supported-scenarios"></a>지원되는 시나리오

MABS는 다음과 같은 시나리오에서 Hyper-v 호스트 서버에서 실행 되는 가상 컴퓨터를 백업할 수 있습니다.

- **로컬 또는 직접 저장소가 있는 가상 컴퓨터** -로컬 또는 직접 연결 된 저장소가 있는 hyper-v 호스트 독립 실행형 서버에서 호스트 되는 가상 컴퓨터를 백업 합니다. 예: 하드 드라이브, SAN (저장 영역 네트워크) 장치 또는 NAS (네트워크 연결 저장소) 장치입니다. 모든 호스트에 MABS 보호 에이전트를 설치 해야 합니다.

- **Csv 저장소를 사용 하는 클러스터의 가상 컴퓨터** -클러스터 공유 볼륨 (csv) 저장소를 사용 하는 hyper-v 클러스터에서 호스트 되는 가상 컴퓨터를 백업 합니다. MABS 보호 에이전트는 각 클러스터 노드에 설치 됩니다.

## <a name="host-versus-guest-backup"></a>호스트 및 게스트 백업

MABS는 Hyper-v Vm의 호스트 또는 게스트 수준 백업을 수행할 수 있습니다. 호스트 수준에서 MABS 보호 에이전트는 Hyper-v 호스트 서버 또는 클러스터에 설치 되 고 해당 호스트에서 실행 되는 전체 Vm 및 데이터 파일을 보호 합니다.   게스트 수준에서 에이전트는 각 가상 컴퓨터에 설치 되 고 해당 컴퓨터에 있는 작업을 보호 합니다.

두 방법 모두 장단점이 있습니다.

- 호스트 수준 백업은 게스트 컴퓨터에서 실행 되는 OS 유형에 상관 없이 작동 하기 때문에 유연 하며 각 VM에서 MABS 보호 에이전트를 설치할 필요가 없습니다. 호스트 수준 백업을 배포 하는 경우 전체 가상 컴퓨터 또는 파일 및 폴더 (항목 수준 복구)를 복구할 수 있습니다.

- 게스트 수준 백업은 가상 머신에서 실행 되는 특정 작업을 보호 하려는 경우에 유용 합니다. 호스트 수준에서 전체 VM 또는 특정 파일을 복구할 수 있지만 특정 응용 프로그램의 컨텍스트에서 복구를 제공 하지는 않습니다. 예를 들어 백업 된 VM에서 특정 SharePoint 항목을 복구 하려면 해당 VM의 게스트 수준 백업을 수행 해야 합니다. 통과 디스크에 저장 된 데이터를 보호 하려는 경우 게스트 수준 백업을 사용 합니다. 통과를 사용 하면 가상 머신이 저장소 장치에 직접 액세스할 수 있으며 가상 볼륨 데이터를 VHD 파일에 저장 하지 않습니다.

## <a name="how-the-backup-process-works"></a>백업 프로세스의 작동 방식

MABS는 다음과 같이 VSS를 사용 하 여 백업을 수행 합니다. 이 설명의 단계는 명확 하 게 이해 하기 위해 번호가 매겨집니다.

1. MABS 블록 기반 동기화 엔진에서는 보호 된 가상 컴퓨터의 초기 복사본을 만들고 가상 컴퓨터의 복사본이 완벽 하 게 일치 하는지 확인 합니다.

2. 초기 복사본이 생성 되 고 확인 된 후 MABS는 Hyper-v VSS 기록기를 사용 하 여 백업을 캡처합니다. VSS 기록기는 MABS 서버와 동기화 된 디스크 블록의 데이터 일관성 집합을 제공 합니다. 이 방법은 MABS 서버를 사용 하는 "전체 백업"의 이점을 제공 하는 동시에 네트워크를 통해 전송 해야 하는 백업 데이터를 최소화 합니다.

3. Hyper-v를 실행 하는 서버의 MABS 보호 에이전트는 기존 Hyper-v Api를 사용 하 여 보호 된 가상 머신에서 VSS도 지원 하는지 여부를 확인 합니다.

   - 가상 머신이 온라인 백업을 위한 요구 사항을 준수 하 고 Hyper-v integration services 구성 요소를 설치한 경우 Hyper-v VSS 기록기는 VSS 요청을 가상 머신의 모든 VSS 인식 프로세스에 반복적으로 전달 합니다. 이 작업은 가상 컴퓨터에 MABS 보호 에이전트를 설치 하지 않고 수행 됩니다. 재귀 VSS 요청을 통해 Hyper-v VSS 기록기는 데이터 손실 없이 VSS 스냅숏을 캡처하도록 디스크 쓰기 작업이 동기화 되도록 할 수 있습니다.

     Hyper-v integration services 구성 요소는 가상 컴퓨터의 VSS (볼륨 섀도 복사본 서비스)에서 Hyper-v VSS 기록기를 호출 하 여 해당 응용 프로그램 데이터가 일관 된 상태 인지 확인 합니다.

   - 가상 컴퓨터가 온라인 백업 요구 사항을 준수 하지 않는 경우 MABS는 자동으로 Hyper-v Api를 사용 하 여 데이터 파일을 캡처하기 전에 가상 컴퓨터를 일시 중지 합니다.

4. 가상 컴퓨터의 초기 기준 복사본이 MABS 서버와 동기화 된 후 가상 컴퓨터 리소스에 대한 모든 변경 내용은 새 복구 지점에서 캡처됩니다. 복구 지점은 특정 시간에 가상 컴퓨터의 일관 된 상태를 나타냅니다. 복구 지점 캡처는 하루에 한 번 이상 발생할 수 있습니다. 새 복구 지점이 생성 되 면 MABS는 Hyper-v VSS 기록기와 함께 블록 수준 복제를 사용 하 여 Hyper-v를 실행 하는 서버에서 마지막 복구 지점이 생성 된 이후 변경 된 블록을 확인 합니다. 그런 다음 이러한 데이터 블록을 MABS 서버로 전송 하 고 보호 된 데이터의 복제본에 적용 합니다.

5. MABS 서버는 여러 섀도 복사본을 사용할 수 있도록 복구 데이터를 호스팅하는 볼륨에서 VSS를 사용 합니다. 이러한 각 섀도 복사본은 별도의 복구를 제공 합니다. VSS 복구 지점은 MABS 서버에 저장 됩니다. Hyper-v를 실행 하는 서버에서 만든 임시 복사본은 MABS 동기화 기간 동안만 저장 됩니다.

>[!NOTE]
>
>Windows Server 2016부터 Hyper-v 가상 하드 디스크에는 .RCT (복원 변경 내용 추적) 라는 기본 제공 변경 내용 추적이 있습니다. MABS는 .RCT (Hyper-v의 기본 변경 추적)를 사용 하므로 VM 충돌과 같은 시나리오에서 시간이 오래 걸리는 일관성 검사의 필요성이 줄어듭니다. RCT는 VSS 스냅샷 기반 백업에서 제공하는 변경 내용 추적보다 더 나은 복원력을 제공합니다. MABS V3은 모든 일관성 검사 중 변경된 데이터만을 전송하여 네트워크 및 스토리지 사용을 더욱 최적화합니다.

## <a name="backup-prerequisites"></a>백업 필수 구성 요소

다음은 MABS를 사용 하 여 Hyper-v 가상 컴퓨터를 백업 하기 위한 필수 구성 요소입니다.

|사전 요구 사항|세부 정보|
|------------|-------|
|MABS 필수 조건|-가상 컴퓨터에 대한 항목 수준 복구를 수행 하려면 (파일, 폴더, 볼륨 복구) MABS 서버에 Hyper-v 역할을 설치 해야 합니다.  항목 수준이 아닌 가상 컴퓨터만 복구 하려는 경우에는 역할이 필요 하지 않습니다.<br />-하나의 MABS 서버에서 각각 100 GB의 가상 컴퓨터를 최대 800 개 보호할 수 있으며, 더 큰 클러스터를 지 원하는 여러 MABS 서버를 허용할 수 있습니다.<br />-MABS는 증분 백업에서 페이지 파일을 제외 하 여 가상 머신 백업 성능을 향상 시킵니다.<br />-MABS는 MABS 서버와 동일한 도메인 또는 자식 도메인 이나 트러스트 된 도메인에 있는 Hyper-v 서버 또는 클러스터를 백업할 수 있습니다. 작업 그룹 또는 신뢰할 수 없는 도메인에서 Hyper-v를 백업 하려면 인증을 설정 해야 합니다. 단일 Hyper-v 서버의 경우 NTLM 또는 인증서 인증을 사용할 수 있습니다. 클러스터의 경우 인증서 인증만 사용할 수 있습니다.<br />-호스트 수준 백업을 사용 하 여 통과 디스크의 가상 컴퓨터 데이터를 백업 하는 것은 지원 되지 않습니다. 이 시나리오에서는 호스트 수준 백업을 사용 하 여 VHD 파일 및 게스트 수준 백업을 백업 하 여 호스트에 표시 되지 않는 다른 데이터를 백업 하는 것이 좋습니다.<br />   -중복 제거 된 볼륨에 저장 된 Vm을 백업할 수 있습니다.|
|Hyper-v VM 필수 구성 요소|-가상 머신에서 실행 되는 통합 구성 요소의 버전은 Hyper-v 호스트의 버전과 동일 해야 합니다. <br />-각 가상 컴퓨터 백업의 경우 Hyper-v에서 백업 중 차이점 보관용 디스크 (.AVHD)에 충분 한 공간을 사용할 수 있도록 가상 하드 디스크 파일을 호스트 하는 볼륨에 사용 가능한 공간이 필요 합니다. 공간은 계산 **초기 디스크 크기\*변동 비율\*백업** 윈도 시간 이상 이어야 합니다. 클러스터에서 여러 백업을 실행 하는 경우이 계산을 사용 하 여 각 가상 머신에 대한 AVHDs를 수용 하기에 충분 한 저장소 용량이 필요 합니다.<br />-Windows Server 2012 r 2를 실행 하는 Hyper-v 호스트 서버에 있는 가상 컴퓨터를 백업 하려면 가상 컴퓨터가 어떤 것에도 연결 되지 않은 경우에도 SCSI 컨트롤러를 지정 해야 합니다. Windows Server 2012 R2 온라인 백업에서 Hyper-v 호스트는 VM에 새 VHD를 탑재 한 다음 나중에 분리 합니다. SCSI 컨트롤러만이를 지원할 수 있으므로 가상 머신의 온라인 백업에 필요 합니다.  이 설정이 없으면 가상 컴퓨터를 백업 하려고 할 때 이벤트 ID 10103이 실행 됩니다.|
|Linux 필수 구성 요소|-MABS 2012 R2를 사용 하 여 Linux 가상 컴퓨터를 백업할 수 있습니다. 파일 일치 스냅숏으로만 지원 됩니다.|
|CSV 저장소를 사용 하 여 Vm 백업|-CSV 저장소의 경우 Hyper-v 서버에 VSS (볼륨 섀도 복사본 서비스) 하드웨어 공급자를 설치 합니다. VSS 하드웨어 공급자에 대한 SAN (저장소 영역 네트워크) 공급 업체에 문의 하십시오.<br />-단일 노드가 CSV 클러스터에서 예기치 않게 종료 되는 경우 MABS는 해당 노드에서 실행 중인 가상 컴퓨터에 대해 일관성 확인을 수행 합니다.<br />-CSV 클러스터에서 BitLocker 드라이브 암호화 사용 하도록 설정 된 Hyper-v 서버를 다시 시작 해야 하는 경우 Hyper-v 가상 컴퓨터에 대한 일관성 확인을 실행 해야 합니다.|
|SMB 저장소를 사용 하 여 Vm 백업|-가상 컴퓨터 보호를 사용 하도록 설정 하려면 Hyper-v를 실행 하는 서버에서 자동 탑재를 설정 합니다.<br />   -TCP Chimney 오프 로드를 사용 하지 않습니다.<br />-모든 Hyper-v machine $ 계정이 특정 원격 SMB 파일 공유에 대한 모든 권한을 보유 하는지 확인 합니다.<br />-대체 위치로의 복구 중 모든 가상 머신 구성 요소의 파일 경로가 260 자 미만인 지 확인 합니다. 그렇지 않은 경우 복구가 성공할 수 있지만 Hyper-v는 가상 컴퓨터를 탑재할 수 없습니다.<br />-다음 시나리오는 지원 되지 않습니다.<br />     가상 컴퓨터의 일부 구성 요소는 로컬 볼륨에 있고 일부 구성 요소는 원격 볼륨에 있는 배포 저장소 위치 파일 서버의 IPv4 또는 IPv6 주소, 원격 SMB 공유를 사용 하는 컴퓨터에 가상 컴퓨터 복구<br />-각 SMB 서버에서 파일 서버 VSS 에이전트 서비스를 사용 하도록 설정 해야 합니다. **역할 및 기능 추가** > **서버 역할** > **파일 및 저장소 서비스** > **파일** 서비스 > **파일 서비스** > **파일 서버 vss 에이전트 서비스**를 선택 합니다.|

## <a name="back-up-virtual-machines"></a>가상 컴퓨터 백업

1. [Mabs 서버](backup-azure-microsoft-azure-backup.md) 및 [저장소](backup-mabs-add-storage.md)를 설정 합니다. 저장소를 설정할 때 이러한 저장소 용량 지침을 사용 합니다.
   - 평균 가상 머신 크기-100 g b
   - MABS 서버당 가상 머신 수-800
   - 800 Vm의 총 크기-80 TB
   - 백업 저장소에 필요한 공간-80 TB

2. Hyper-v 서버 또는 Hyper-v 클러스터 노드에서 MABS 보호 에이전트를 설정 합니다. 게스트 수준 백업을 수행 하는 경우 게스트 수준에서 백업 하려는 Vm에 에이전트를 설치 합니다.

3. MABS 관리자 콘솔에서 **보호** 를 클릭 하 > **보호 그룹 만들기** 를 클릭 하 여 **새 보호 그룹 만들기** 마법사를 엽니다.

4. **그룹 구성원 선택** 페이지에서 보호 하려는 vm이 있는 hyper-v 호스트 서버에서 보호 하려는 vm을 선택 합니다. 동일한 보호 정책을 포함 하는 모든 Vm을 하나의 보호 그룹에 배치 하는 것이 좋습니다. 공간을 효율적으로 사용 하려면 공동 배치를 사용 하도록 설정 합니다. 공동 배치를 사용 하면 동일한 디스크 또는 테이프 저장소에 있는 다른 보호 그룹의 데이터를 찾을 수 있으므로 여러 데이터 원본에 단일 복제본 및 복구 지점 볼륨이 있습니다.

5. **데이터 보호 방법 선택** 페이지에서 보호 그룹 이름을 지정 합니다. Azure Backup 서비스를 사용 하 여 Azure에 데이터를 백업 하려는 경우 **디스크를 사용 하는 단기 보호 사용** 을 선택 하 고 **온라인 보호** 를 선택 합니다.

6. **단기 목표 지정** > **보존 범위**에서 디스크 데이터를 보존할 기간을 지정 합니다. **동기화 빈도**에서 데이터 증분 백업을 실행할 빈도를 지정 합니다. 또는 증분 백업의 간격을 선택 하는 대신 **복구 지점**직전을 사용 하도록 설정할 수 있습니다. 이 설정을 사용 하도록 설정 하면 MABS는 예약 된 각 복구 지점 직전에 빠른 전체 백업을 실행 합니다.

    > [!NOTE]
    >
    >응용 프로그램 작업을 보호 하는 경우 응용 프로그램에서 증분 백업을 지 원하는 경우 동기화 빈도에 따라 복구 지점이 생성 됩니다. 그렇지 않은 경우 MABS는 증분 백업 대신 빠른 전체 백업을 실행 하 고 빠른 백업 일정에 따라 복구 지점이 생성 됩니다.

7. **디스크 할당 검토** 페이지에서 보호 그룹에 할당 된 저장소 풀 디스크 공간을 검토 합니다.

   **전체 데이터 크기** 는 백업 하려는 데이터의 크기 이며 **mabs에서 프로 비전 될 디스크 공간은** mabs에서 보호 그룹에 대해 권장 하는 공간입니다. MABS는 설정에 따라 이상적인 백업 볼륨을 선택 합니다. 그러나 **디스크 할당 세부 정보**에서 백업 볼륨 선택을 편집할 수 있습니다. 워크로드의 경우 드롭다운 메뉴에서 원하는 스토리지를 선택합니다. 편집을 통해 **사용 가능한 디스크 스토리지** 창에서 **총 스토리지** 및 **사용 가능한 스토리지**의 값을 변경합니다. 프로 비전 된 공간 미달은 나중에 백업을 원활 하 게 진행 하기 위해 볼륨에 추가 하는 저장소 MABS의 용량입니다.

8. **복제본 만들기 방법 선택** 페이지에서 보호 그룹에 있는 데이터의 초기 복제를 수행 하는 방법을 지정 합니다. **네트워크를 통해 자동으로 복제**를 선택 하는 경우 사용량이 적은 시간을 선택 하는 것이 좋습니다. 데이터 양이 많거나 최적의 네트워크 상태가 아닌 경우에는 이동식 미디어를 사용 하 여 오프 라인으로 데이터를 복제 해야 하는 **수동으로**선택 하는 것이 좋습니다.

9. **일관성 확인 옵션** 페이지에서 일관성 확인을 자동화 하는 방법을 선택 합니다. 복제본 데이터가 일치 하지 않거나 일정에 따라 실행 되도록 검사를 사용 하도록 설정할 수 있습니다. 자동 일관성 확인을 구성 하지 않으려면 언제 든 지 보호 그룹을 마우스 오른쪽 단추로 클릭 하 고 **일관성 확인 수행**을 선택 하 여 수동 확인을 실행할 수 있습니다.

    보호 그룹을 만든 후에는 선택한 방법에 따라 데이터의 초기 복제가 수행 됩니다. 초기 복제 후에는 각 백업이 보호 그룹 설정에 맞게 발생 합니다. 백업 된 데이터를 복구 해야 하는 경우 다음에 유의 하십시오.

## <a name="back-up-virtual-machines-configured-for-live-migration"></a>실시간 마이그레이션을 위해 구성 된 가상 컴퓨터 백업

가상 컴퓨터가 실시간 마이그레이션에 포함 되어 있는 경우 mabs는 MABS 보호 에이전트가 Hyper-v 호스트에 설치 되어 있는 한 가상 컴퓨터를 계속 보호 합니다. MABS에서 가상 컴퓨터를 보호 하는 방법은 관련 된 실시간 마이그레이션의 유형에 따라 달라 집니다.

**클러스터 내 실시간 마이그레이션** -클러스터 내에서 가상 머신을 마이그레이션하는 경우에서 마이그레이션을 검색 하 고 사용자 개입 없이 새 클러스터 노드에서 가상 머신을 백업 합니다. 저장소 위치가 변경 되지 않았기 때문에 MABS는 빠른 전체 백업을 진행 합니다.

**클러스터 외부에서 실시간 마이그레이션** -가상 컴퓨터를 독립 실행형 서버 간에 또는 독립 실행형 서버와 클러스터 간에 마이그레이션하는 경우 mabs에서 마이그레이션을 검색 하 고 사용자 개입 없이 가상 컴퓨터를 백업할 수 있습니다.

### <a name="requirements-for-maintaining-protection"></a>보호 유지를 위한 요구 사항

실시간 마이그레이션 중에 보호를 유지 하기 위한 요구 사항은 다음과 같습니다.

- 가상 컴퓨터의 Hyper-v 호스트는 system center VMM 클라우드에 system center 2012 s p 1 이상을 실행 하는 VMM 서버에 있어야 합니다.

- 모든 Hyper-v 호스트에 MABS 보호 에이전트를 설치 해야 합니다.

- MABS 서버는 VMM 서버에 연결 되어 있어야 합니다. VMM 클라우드의 모든 Hyper-v 호스트 서버도 MABS 서버에 연결 되어야 합니다. 그러면 MABS에서 VMM 서버와 통신 하 여 가상 머신이 현재 실행 중인 Hyper-v 호스트 서버를 확인 하 고 해당 Hyper-v 서버에서 새 백업을 만들 수 있습니다. Hyper-v 서버에 대한 연결을 설정할 수 없는 경우 MABS 보호 에이전트에 연결할 수 없다는 메시지와 함께 백업이 실패 합니다.

- 모든 MABS 서버, VMM 서버 및 Hyper-v 호스트 서버는 동일한 도메인에 있어야 합니다.

### <a name="details-about-live-migration"></a>실시간 마이그레이션에 대한 세부 정보

실시간 마이그레이션 중 백업에 대한 다음 사항에 유의 하세요.

- 실시간 마이그레이션에서 저장소를 전송 하는 경우 MABS는 가상 컴퓨터의 전체 일관성 확인을 수행한 후 빠른 전체 백업을 진행 합니다. 저장소에 대한 실시간 마이그레이션이 수행 되 면 Hyper-v에서 VHD (가상 하드 디스크) 또는 VHDX를 재구성 하 여 MABS 백업 데이터의 크기에 대한 일회성 스파이크를 발생 시킵니다.

- 가상 컴퓨터 호스트에서 자동 탑재를 설정 하 여 가상 보호를 사용 하도록 설정 하 고 TCP Chimney 오프 로드를 사용 하지 않도록 설정 합니다.

- MABS는 DPM-VMM 도우미 서비스를 호스트 하기 위한 기본 포트로 포트 6070을 사용 합니다. 레지스트리를 변경 하려면:

    1. **HKLM\Software\Microsoft\Microsoft Data Protection Manager\Configuration**로 이동 합니다.
    2. 32 비트 DWORD 값 DpmVmmHelperServicePort을 만들고 레지스트리 키의 일부로 업데이트 된 포트 번호를 씁니다.
    3. ```<Install directory>\Azure Backup Server\DPM\DPM\VmmHelperService\VmmHelperServiceHost.exe.config```를 열고 포트 번호를 6070에서 새 포트로 변경 합니다. 예: ```<add baseAddress="net.tcp://localhost:6080/VmmHelperService/" />```
    4. DPM-VMM 도우미 서비스를 다시 시작 하 고 DPM 서비스를 다시 시작 합니다.

### <a name="set-up-protection-for-live-migration"></a>실시간 마이그레이션에 대한 보호 설정

실시간 마이그레이션에 대한 보호를 설정 하려면:

1. MABS 서버와 해당 저장소를 설정 하 고 VMM 클라우드의 모든 Hyper-v 호스트 서버 또는 클러스터 노드에 MABS 보호 에이전트를 설치 합니다. 클러스터에서 SMB 저장소를 사용 하는 경우 모든 클러스터 노드에 MABS 보호 에이전트를 설치 합니다.

2. MABS가 VMM 서버와 통신할 수 있도록 MABS 서버에 클라이언트 구성 요소로 VMM 콘솔을 설치 합니다. 콘솔은 VMM 서버에서 실행 되는 것과 동일한 버전 이어야 합니다.

3. MABSMachineName $ 계정을 VMM 관리 서버의 읽기 전용 관리자 계정으로 할당 합니다.

4. `Set-DPMGlobalProperty` PowerShell cmdlet을 사용 하 여 모든 Hyper-v 호스트 서버를 모든 MABS 서버에 연결 합니다. Cmdlet은 여러 MABS 서버 이름을 허용 합니다. 사용할 형식: `Set-DPMGlobalProperty -dpmservername <MABSservername> -knownvmmservers <vmmservername>`. 자세한 내용은 [Set-DPMGlobalProperty](https://technet.microsoft.com/library/hh881752.aspx)를 참조 하세요.

5. Vmm 클라우드의 Hyper-v 호스트에서 실행 중인 모든 가상 컴퓨터가 VMM에서 검색 된 후 보호 그룹을 설정 하 고 보호 하려는 가상 컴퓨터를 추가 합니다. 가상 컴퓨터 이동성 시나리오에서는 보호를 위한 보호 그룹 수준에서 자동 일관성 확인을 사용 하도록 설정 해야 합니다.

6. 설정이 구성 된 후에는 가상 컴퓨터가 클러스터 간에 마이그레이션되면 모든 백업이 예상 대로 진행 됩니다. 다음과 같이 예상 대로 실시간 마이그레이션이 사용 되는지 확인할 수 있습니다.

   1. DPM-VMM 도우미 서비스가 실행 중인지 확인 합니다. 그렇지 않은 경우 시작 합니다.

   2. Microsoft SQL Server Management Studio를 열고 MABS 데이터베이스 (DPMDB)를 호스팅하는 인스턴스에 연결 합니다. DPMDB에서 다음 쿼리를 실행 합니다. `SELECT TOP 1000 [PropertyName] ,[PropertyValue] FROM[DPMDB].[dbo].[tbl_DLS_GlobalSetting]`.

      이 쿼리에는 `KnownVMMServer`라는 속성이 포함 되어 있습니다. 이 값은 `Set-DPMGlobalProperty` cmdlet에 제공한 값과 동일 해야 합니다.

   3. 다음 쿼리를 실행 하 여 특정 가상 머신에 대한 `PhysicalPathXML` *VMMIdentifier* 매개 변수의 유효성을 검사 합니다. `VMName`을 가상 컴퓨터의 이름으로 바꿉니다.

      ```sql
      select cast(PhysicalPath as XML) from tbl_IM_ProtectedObject where DataSourceId in (select datasourceid from tbl_IM_DataSource   where DataSourceName like '%<VMName>%')
      ```

   4. 이 쿼리에서 반환 하는 .xml 파일을 열고 *VMMIdentifier* 필드에 값이 있는지 확인 합니다.

### <a name="run-manual-migration"></a>수동 마이그레이션 실행

이전 섹션의 단계를 완료 하 고 MABS 요약 관리자 작업이 완료 되 면 마이그레이션이 사용 됩니다. 기본적으로이 작업은 자정에 시작 되 고 매일 아침에 실행 됩니다. 수동 마이그레이션을 실행 하려는 경우 모든 것이 예상 대로 작동 하는지 확인 하려면 다음을 수행 합니다.

1. SQL Server Management Studio를 열고 MABS 데이터베이스를 호스팅하는 인스턴스에 연결 합니다.

2. 다음 쿼리를 실행 합니다. `select * from tbl_SCH_ScheduleDefinition where JobDefinitionID='9B30D213-B836-4B9E-97C2-DB03C3EB39D7'`. 이 쿼리는 **ScheduleID**를 반환 합니다. 다음 단계에서 사용할 때이 ID를 확인 합니다.

3. SQL Server Management Studio에서 **SQL Server 에이전트**를 확장 한 다음 **작업**을 확장 합니다. 기록한 **ScheduleID** 를 마우스 오른쪽 단추로 클릭 하 고 **작업 시작 단계**를 선택 합니다.

백업 성능은 작업이 실행 될 때 영향을 받습니다. 배포의 크기와 크기에 따라 작업을 완료 하는 데 걸리는 시간이 결정 됩니다.

## <a name="back-up-replica-virtual-machines"></a>복제본 가상 컴퓨터 백업

MABS가 Windows Server 2012 R2 이상에서 실행 되는 경우 복제본 가상 컴퓨터를 백업할 수 있습니다. 이는 다음과 같은 여러 가지 이유로 유용 합니다.

**실행 중인 워크 로드에 대한 백업의 영향 감소** -스냅숏을 만들 때 일부 오버 헤드를 초래 하는 가상 머신의 백업을 수행 합니다. 보조 원격 사이트에 백업 프로세스를 오프 로드 하면 실행 중인 작업은 더 이상 백업 작업의 영향을 받지 않습니다. 이는 원격 사이트에 백업 복사본이 저장 되어 있는 배포에만 적용 됩니다. 예를 들어, 매일 백업을 수행 하 고 빠른 복원 시간을 보장 하기 위해 로컬로 데이터를 저장할 수 있지만 장기 보존을 위해 원격으로 저장 된 복제본 가상 컴퓨터에서 월별 또는 분기별 백업을 수행할 수 있습니다.

**대역폭 절약** -일반적인 원격 지점 사무실/본사 배포 시 사이트 간에 백업 데이터를 전송 하기 위해 적절 한 양의 프로 비전 된 대역폭이 필요 합니다. 데이터 백업 전략 외에도 복제 및 장애 조치 (failover) 전략을 만드는 경우 네트워크를 통해 전송 되는 중복 데이터의 양을 줄일 수 있습니다. 주 데이터베이스가 아니라 복제본 가상 머신 데이터를 백업 하 여 네트워크를 통해 백업 된 데이터를 보내는 오버 헤드를 줄일 수 있습니다.

**호스터 백업 사용** -보조 데이터 센터가 없어도 호스트 된 데이터 센터를 복제 사이트로 사용할 수 있습니다. 이 경우 호스터 SLA는 복제본 가상 컴퓨터의 일관 된 백업이 필요 합니다.

장애 조치 (failover)가 시작 될 때까지 복제본 가상 머신은 꺼져 있으며 VSS는 복제본 가상 머신에 대한 응용 프로그램 일치 백업을 보장할 수 없습니다. 따라서 복제본 가상 머신의 백업은 크래시 일치에만 적용 됩니다. 크래시 일관성을 보장할 수 없는 경우 백업이 실패 하 고 다음과 같은 다양 한 조건에서 발생할 수 있습니다.

- 복제본 가상 컴퓨터가 정상이 아니며 위험 상태입니다.

- 복제본 가상 머신이 다시 동기화 중 (다시 동기화 진행 중 또는 다시 동기화 필요 상태)입니다.

- 가상 컴퓨터에 대한 기본 사이트와 보조 사이트 간의 초기 복제가 진행 중이거나 보류 중입니다.

- . hrl 로그를 복제본 가상 컴퓨터에 적용 하거나 이전 작업을 적용 하 여 가상 디스크에 대한 hrl 로그를 적용 하는 데 실패 했거나 작업이 취소 되었거나 중단 되었습니다.

- 복제본 가상 컴퓨터의 마이그레이션 또는 장애 조치 (failover)가 진행 중입니다.

## <a name="recover-backed-up-virtual-machines"></a>백업 가상 컴퓨터 복구

백업 된 가상 컴퓨터를 복구할 수 있는 경우 복구 마법사를 사용 하 여 가상 컴퓨터 및 특정 복구 지점을 선택 합니다. 복구 마법사를 열고 가상 컴퓨터를 복구 하려면:

1. MABS 관리자 콘솔에서 VM의 이름을 입력 하거나 보호 된 항목의 목록을 확장 하 고 복구 하려는 VM을 선택 합니다.

2. **복구 지점의 대상** 창에서 달력의 날짜를 클릭 하 여 사용 가능한 복구 지점이 표시 됩니다. 그런 다음 **경로** 창에서 복구 마법사에서 사용할 복구 지점을 선택 합니다.

3. **작업** 메뉴 **에서 복구를 클릭 하 여** 복구 마법사를 엽니다.

    선택한 VM 및 복구 지점이 **복구 선택 사항 확인** 화면에 표시 됩니다. **다음**을 클릭합니다.

4. **복구 유형 선택** 화면에서 데이터를 복원할 위치를 선택 하 고 **다음**을 클릭 합니다.

    - **원본 인스턴스에 복구**: 원본 인스턴스로 복구 하면 원본 VHD가 삭제 됩니다. MABS는 Hyper-v VSS 기록기를 사용 하 여 원본 위치에 VHD 및 기타 구성 파일을 복구 합니다. 복구 프로세스가 끝날 때 가상 머신은 여전히 항상 사용 가능 합니다.
        복구 하려면 리소스 그룹이 있어야 합니다. 사용할 수 없는 경우 대체 위치에 복구한 후 가상 머신을 항상 사용 가능 하 게 설정 합니다.

    - **모든 호스트에 가상 머신으로 복구**: mabs는 프로세서 아키텍처와 관계 없이 보호 된 hyper-v 가상 머신을 다른 hyper-v 호스트로 원활 하 게 복구 하는 alr (대체 위치 복구)을 지원 합니다. 클러스터 노드로 복구 되는 hyper-v 가상 컴퓨터는 항상 사용 가능 하지 않습니다. 이 옵션을 선택 하는 경우 복구 마법사는 대상 경로와 대상 경로를 식별 하기 위한 추가 화면을 표시 합니다.

    - **네트워크 폴더에 복사**: Mabs는 hyper-v 가상 컴퓨터의 호스트 수준 백업에서 mabs 보호 된 서버의 네트워크 공유 나 볼륨으로 파일, 폴더, 볼륨 및 vhd (가상 하드 디스크)의 항목 수준 복구를 수행할 수 있도록 하는 ILR (항목 수준 복구)를 지원 합니다. MABS 보호 에이전트를 게스트 내에 설치 하지 않아도 항목 수준 복구를 수행할 수 있습니다. 이 옵션을 선택 하는 경우 복구 마법사는 대상 경로와 대상 경로를 식별 하기 위한 추가 화면을 표시 합니다.

5. **복구 옵션 지정** 에서 복구 옵션을 구성 하 고 **다음**을 클릭 합니다.

    - 낮은 대역폭을 통해 VM을 복구 하는 경우 **수정** 을 클릭 하 여 **네트워크 대역폭 사용 제한을**사용 하도록 설정 합니다. 제한 옵션을 켠 후 사용할 수 있는 대역폭의 양과 해당 대역폭을 사용할 수 있는 시간을 지정할 수 있습니다.
    - 네트워크를 구성한 경우 **하드웨어 스냅숏을 사용 하 여 SAN 기반 복구 사용** 을 선택 합니다.
    - 복구 프로세스가 완료 되 면 전자 메일 알림을 보내도록 하려면 **복구를 완료 하면 전자 메일 보내기** 를 선택 하 고 전자 메일 주소를 제공 합니다.

6. 요약 화면에서 모든 세부 정보가 올바른지 확인 합니다. 세부 정보가 올바르지 않거나 변경 하려면 **뒤로**를 클릭 합니다. 설정에 만족 하는 **경우 복구를 클릭 하** 여 복구 프로세스를 시작 합니다.

7. 복구 **상태** 화면에 복구 작업에 대한 정보가 제공 됩니다.

## <a name="next-steps"></a>다음 단계

[Azure Backup Server에서 데이터 복구](https://docs.microsoft.com/azure/backup/backup-azure-alternate-dpm-server)
