---
title: Azure Stream Analytics를 사용 하 여 지 오 펜싱 및 지리 공간 집계 시나리오
description: 이 문서에서는 Azure Stream Analytics를 사용 하 여 지 오 펜싱 및 지리 공간 집계에 대 한 방법을 설명 합니다.
services: stream-analytics
author: mamccrea
ms.author: mamccrea
ms.service: stream-analytics
ms.topic: conceptual
ms.date: 04/02/2019
ms.openlocfilehash: cc301855e4cdcb8eb687e753835577399cfe72b0
ms.sourcegitcommit: 3102f886aa962842303c8753fe8fa5324a52834a
ms.translationtype: MT
ms.contentlocale: ko-KR
ms.lasthandoff: 04/23/2019
ms.locfileid: "60789566"
---
# <a name="geofencing-and-geospatial-aggregation-scenarios-with-azure-stream-analytics"></a>Azure Stream Analytics를 사용 하 여 지 오 펜싱 및 지리 공간 집계 시나리오

기본 지리 공간적 함수를 사용 하 여 fleet 관리 등의 시나리오에 대 한 응용 프로그램을 빌드, 공유, 연결 된 자동차 및 자산 추적 재정의 Azure Stream Analytics를 사용할 수 있습니다.

## <a name="geofencing"></a>지오펜싱

Azure Stream Analytics는 클라우드 및 IoT Edge 런타임에서 대기 시간이 짧은 실시간 지 오 펜싱 계산을 지원합니다.

### <a name="geofencing-scenario"></a>지 오 펜싱 시나리오

제조 회사의 건물에서 자산을 추적 해야 합니다. GPS 사용 하 여 모든 장치를 장착 하 하며 장치를 특정 영역을 퇴사 하는 경우 알림을 받으려면.

이 예제에서 사용 하는 참조 데이터는 건물 및 각 건물에 허용 되는 장치에 대해 지역 구분 정보. 참조 데이터 일 수도 있고 정적 이거나 느리게 변경 해야 합니다. 이 시나리오에 대 한 정적 참조 데이터 사용 됩니다. 장치 ID 및 현재 위치에 지속적으로 데이터 스트림을 내보냅니다.

### <a name="define-geofences-in-reference-data"></a>참조 데이터의 지역 구분을 정의 합니다.

GeoJSON 개체를 사용 하는 지역 구분을 정의할 수 있습니다. 호환성 버전 1.2 이상으로 작업에 대 한 지역 구분 정의할 수도 있습니다 텍스트 WKT (Well Known)으로 사용 하 여 `NVARCHAR(MAX)`입니다. WKT는 컨소시엄 OGC (Open Geospatial) 표준 텍스트 형식으로 공간 데이터를 나타내는 데 사용 되는 경우

기본 지리 공간적 함수 정의 된 지역 구분을 사용 요소 인지 또는 특정 지역 구분 다각형에서 찾을 수 있습니다.

다음 표는 Azure blob storage 또는 Azure SQL 테이블에 저장할 수 있는 지역 구분 참조 데이터의 예입니다. 모든 사이트는 지리 공간적 다각형으로 표현 되 고 허용 된 사이트 ID와 사용 하 여 연결 된 모든 장치

|SiteID|SiteName|지오펜스|AllowedDeviceID|
|------|--------|--------|---------------|
|1|"Redmond Building 41"|"POLYGON ((-122.1337357922017 47.63782998329432,-122.13373042778369 47.637634793257305,-122.13346757130023 47.637642022530954,-122.13348902897235 47.637508280806806,-122.13361777500506 47.637508280806806,-122.13361241058703 47.63732393354484,-122.13265754417773 47.63730947490855,-122.13266290859576 47.637519124743164,-122.13302232460376 47.637515510097955,-122.13301696018573 47.63764925180358,-122.13272728161212 47.63764925180358,-122.13274873928424 47.63784082716388,-122.13373579220172 47.63782998329432)) "|"B"|
|2|"Redmond Building 40"|"POLYGON ((-122.1336154507967 47.6366745947009,-122.13361008637867 47.636483015064535,-122.13349206918201 47.636479400347675,-122.13349743360004 47.63636372927573,-122.13372810357532 47.63636372927573,-122.13373346799335 47.63617576323771,-122.13263912671528 47.63616491902258,-122.13264985555134 47.63635649982525,-122.13304682248554 47.636367344000604,-122.13305218690357 47.63650831807564,-122.13276250832996 47.636497473929516,-122.13277323716602 47.63668543881025,-122.1336154507967 47.6366745947009)) "|"A"|
|3|"Redmond Building 22"|"POLYGON ((-122.13611660248233 47.63758544698554,-122.13635263687564 47.6374083293018,-122.13622389084293 47.63733603619712,-122.13622389084293 47.63717699101473,-122.13581619507266 47.63692757827657,-122.13559625393344 47.637046862778135,-122.13569281345798 47.637144458985965,-122.13570890671207 47.637314348246214,-122.13611660248233 47.63758544698554)) "|"C"|

### <a name="generate-alerts-with-geofence"></a>지역 구분을 사용 하 여 경고를 생성 합니다.

장치를 내보낼 수 있습니다 위치와 ID 라는 스트림을 통해 매분 `DeviceStreamInput`합니다. 다음 표에서 입력 스트림입니다.

|DeviceID|GeoPosition|
|--------|-----------|
|"A"|"POINT(-122.13292341559497 47.636318374032726)"|
|"B"|"POINT(-122.13338475554553 47.63743531308874)"|
|"C"|"POINT(-122.13354001095752 47.63627622505007)"|

참조 데이터를 지역 구분을 사용 하 여 장치 스트림을 조인 하 고 장치는 허용 된 건물 외부 때마다 경고를 생성 하는 쿼리를 작성할 수 있습니다.

```SQL
SELECT DeviceStreamInput.DeviceID, SiteReferenceInput.SiteID, SiteReferenceInput.SiteName 
INTO Output
FROM DeviceStreamInput 
JOIN SiteReferenceInput
ON st_within(DeviceStreamInput.GeoPosition, SiteReferenceInput.Geofence) = 0
WHERE DeviceStreamInput.DeviceID = SiteReferenceInput.AllowedDeviceID
```

다음 이미지는 지역 구분을 나타냅니다. 입력 스트림 데이터에 따라에서 장치는 여기서 확인할 수 있습니다.

![빌드 지역 구분](./media/geospatial-scenarios/building-geofences.png)

장치 "C"는 건물 ID 2 참조 데이터에 따라 허용 되지 않는 내부에 있습니다. 이 장치 ID가 3 빌드 내에 있어야 합니다. 이 작업을 실행은이 특정 위반에 대 한 경고를 생성 합니다.

### <a name="site-with-multiple-allowed-devices"></a>여러 허용 된 장치를 사용 하 여 사이트

사이트를 여러 장치를 허용 하는 경우 장치 Id의 배열을 정의할 수 있습니다 `AllowedDeviceID` 에서 사용자 정의 함수를 사용할 수 있습니다는 `WHERE` stream 장치 ID를 해당 목록의 모든 장치 ID를 일치 하는지 확인 하는 절. 자세한 내용은 합니다 [Javascript UDF](stream-analytics-javascript-user-defined-functions.md) 클라우드 작업에 대 한 자습서와 [ C# UDF](stream-analytics-edge-csharp-udf.md) edge 작업에 대 한 자습서입니다.

## <a name="geospatial-aggregation"></a>지리 공간 집계

Azure Stream Analytics는 클라우드 및 IoT Edge 런타임에서 짧은 대기 시간 지리 공간적 실시간 집계를 지원합니다.

### <a name="geospatial-aggregation-scenario"></a>지리 공간 집계 시나리오

Cab 회사는 현재 더 높은 요청을 발생 하는 도시가의 영역으로 승객을 찾고 해당 cab 드라이버를 안내 하는 실시간 응용 프로그램을 작성 하려고 합니다.

회사 참조 데이터로 도시 논리 영역을 저장합니다. 각 지역 RegionID, RegionName, 및 지역 구분을 기준으로 정의 됩니다.

### <a name="define-the-geofences"></a>지역 구분을 정의 합니다.

다음 표는 Azure blob storage 또는 Azure SQL 테이블에 저장할 수 있는 지역 구분 참조 데이터의 예입니다. 스트리밍 데이터에서 들어오는 요청과 상호 연결 하는 데 사용 되는 지리 공간적 다각형으로 모든 지역이 표시 됩니다.

이러한 다각형 참조용일 뿐 이며 실제 도시 논리적 또는 물리적 분리를 나타내지 않습니다.

|RegionID|RegionName|지오펜스|
|--------|----------|--------|
|1|"SoHo"|"POLYGON ((-74.00279525078275 40.72833625216264,-74.00547745979765 40.721929158663244,-74.00125029839018 40.71893680218994,-73.9957785919998 40.72521409075776,-73.9972377137039 40.72557184584898,-74.00279525078275 40.72833625216264) )"|
|2|"Chinatown"|"POLYGON ((-73.99712367114876 40.71281582267133,-73.9901070123658 40.71336881907936,-73.99023575839851 40.71452359088633,-73.98976368961189 40.71554823078944,-73.99551434573982 40.717337246783735,-73.99480624255989 40.718491949759304,-73.99652285632942 40.719109951574,-73.99776740131233 40.7168005470334,-73.99903340396736 40.71727219249899,-74.00193018970344 40.71938642421256,-74.00409741458748 40.71688186545551,-74.00051398334358 40.71517415773184,-74.0004281526551 40.714377212470005,-73.99849696216438 40.713450141693166,-73.99748845157478 40.71405192594819,-73.99712367114876 40.71281582267133)) "|
|3|"Tribeca"|"POLYGON ((-74.01091641815208 40.72583120006787,-74.01338405044578 40.71436586362705,-74.01370591552757 40.713617702123415,-74.00862044723533 40.711308107057235,-74.00194711120628 40.7194238654018,-74.01091641815208 40.72583120006787)) "|

### <a name="aggregate-data-over-a-window-of-time"></a>시간 창에 대 한 집계 데이터

다음 표에서 스트리밍 데이터 "탑승."

|UserID|FromLocation|ToLocation|TripRequestedTime|
|------|------------|----------|-----------------|
|"A"|"POINT(-74.00726861389182 40.71610611981975)"|"POINT(-73.98615095917779 40.703107386025835)"|"2019-03-12T07:00:00Z"|
|"B"|"POINT(-74.00249841021645 40.723827238895666)"|"POINT(-74.01160699942085 40.71378884930115)"|"2019-03-12T07:01:00Z"|
|"C"|"POINT(-73.99680120565864 40.716439898624024)"|"POINT(-73.98289663412544 40.72582343969828)"|"2019-03-12T07:02:00Z"|
|"D"|"POINT(-74.00741090068288 40.71615626755086)"|"POINT(-73.97999843120539 40.73477895807408)"|"2019-03-12T07:03:00Z"|

다음 쿼리는 지역 구분 참조 데이터를 사용 하 여 장치 스트림을 조인 하 고 1 분 마다 15 분의 기간에는 지역 당 요청 수를 계산 합니다.

```SQL
SELECT count(*) as NumberOfRequests, RegionsRefDataInput.RegionName 
FROM UserRequestStreamDataInput
JOIN RegionsRefDataInput 
ON st_within(UserRequestStreamDataInput.FromLocation, RegionsRefDataInput.Geofence) = 1
GROUP BY RegionsRefDataInput.RegionName, hoppingwindow(minute, 1, 15)
```

이 쿼리 요청 수가 지난 15 분 동안 1 분 마다 도시 내에서 각 지역에 따라 출력합니다. 이 정보는 Power BI 대시보드를 쉽게 표시할 수 있습니다 또는 Azure functions와 같은 서비스와의 통합을 통해 SMS 문자 메시지를 모든 드라이버에 브로드캐스트 될 수 있습니다.

아래 이미지에서는 Power BI 대시보드에 쿼리 출력을을 보여 줍니다. 

![Power BI 대시보드에서 결과 출력](./media/geospatial-scenarios/power-bi-output.png)


## <a name="next-steps"></a>다음 단계

* [Stream Analytics 지리 공간적 함수 소개](stream-analytics-geospatial-functions.md)
* [지리 공간적 함수 (Azure Stream Analytics)](https://docs.microsoft.com/stream-analytics-query/geospatial-functions)
